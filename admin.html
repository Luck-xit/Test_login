<!doctype html>
<html lang="es">  
<head>  
<meta charset="utf-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1" />  
<title>Admin — Luck modz</title>  
<link rel="icon" href="data:;base64,iVBORw0KGgo=">  
<style>  
/* (se mantiene exactamente igual todo tu CSS original) */
</style>
</head>  
<body>  
  <!-- (se mantiene exactamente igual tu HTML del body y paneles) -->

<script type="module">  
// FIREBASE IMPORTS  
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";  
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";  
import { getDatabase, ref, onValue, push, set, remove, update, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";  

// config (igual a tuyo)  
const firebaseConfig = {  
  apiKey: "AIzaSyD9_Wps61TDrx6PVfKgzvgoQLGlIRrzSaA",  
  authDomain: "weblogin-bbd5f.firebaseapp.com",  
  databaseURL: "https://weblogin-bbd5f-default-rtdb.firebaseio.com",  
  projectId: "weblogin-bbd5f",  
  storageBucket: "weblogin-bbd5f.firebasestorage.app",  
  messagingSenderId: "446557224878",  
  appId: "1:446557224878:web:0c626cf886d4ae9ad9523f",  
  measurementId: "G-33G9QVHQGQ"  
};  
const app = initializeApp(firebaseConfig);  
const auth = getAuth(app);  
const db = getDatabase(app);  

// (tus mismas referencias DOM y variables...)

let editingId = null;  
let allHacks = {};  
let currentUserProfile = null;  
let metrics = { visitantes:0, cliqueos:0, tiempo:'0h 0m' };  

// (funciones toast, overlay, escape, clearForm quedan igual)

// AUTH + AUTORIZACIÓN  
onAuthStateChanged(auth, async (user)=>{  
  if (!user){  
    window.location.href = 'index.html';  
    return;  
  }  
  adminEmailEl.textContent = (user.email || user.displayName || 'usuario');  

  const userRef = ref(db, 'users/' + user.uid);  
  try {  
    const snap = await get(userRef);  
    if (!snap.exists()){  
      showToast('Perfil no encontrado. Contacta al administrador.');  
      setTimeout(async ()=> { await signOut(auth); window.location.href='index.html'; }, 1800);  
      return;  
    }  
    const profile = snap.val();  
    currentUserProfile = profile;  

    if (!profile.authorized){  
      showToast('No estás autorizado para entrar al admin.');  
      setTimeout(async ()=>{ await signOut(auth); window.location.href='index.html'; }, 1600);  
      return;  
    }  

    createdByIn.value = profile.username || user.email || '';  
    initAdmin();  
  } catch(e){  
    console.error(e);  
    showToast('Error verificando autorización');  
    setTimeout(async ()=>{ await signOut(auth); window.location.href='index.html'; }, 1600);  
  }  
});  

// (signOut y backToDash igual)

// HACKS: LISTAR EN TIEMPO REAL  
function listenHacks(){  
  const hacksRef = ref(db, 'hacks');  
  onValue(hacksRef, (snap)=>{  
    const val = snap.val() || {};  
    allHacks = val;  
    renderHacksList();  
    totalHacksEl.textContent = Object.keys(val).length;  
  });  
}  

function renderHacksList(filter=''){  
  hacksList.innerHTML = '';  
  const arr = Object.entries(allHacks || {});  
  const q = (filter||'').trim().toLowerCase();  

  arr.sort((a,b)=> (b[1].timestamp||0) - (a[1].timestamp||0));  

  const currentUserEmail = auth.currentUser?.email || '';  
  const currentUsername = currentUserProfile?.username || '';  

  // filtrar SOLO hacks del usuario logueado  
  const myHacks = arr.filter(([id,h]) => {  
    return (h.createdBy === currentUserEmail || h.createdByUsername === currentUsername);  
  });  

  if (myHacks.length === 0){  
    hacksList.innerHTML = `<div class="small" style="color:var(--muted)">No tienes hacks publicados.</div>`;  
    return;  
  }  

  myHacks.forEach(([id, h])=>{  
    const title = h.title || 'Sin título';  
    const game = h.game || 'Sin juego';  
    const cat = h.category || 'Sin categoría';  
    const desc = h.description || '';  
    const img = h.imageURL || '';  
    const createdByName = h.createdByUsername || h.createdBy || '—';  

    // filtro búsqueda  
    if (q && !(title.toLowerCase().includes(q) || game.toLowerCase().includes(q) || (createdByName||'').toLowerCase().includes(q))) return;  

    const div = document.createElement('div');  
    div.className = 'hack';  
    div.innerHTML = `  
      <div class="thumb"><img src="${escapeAttr(img)}" alt="${escapeAttr(title)}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=200 height=120><rect width=100% height=100% fill=%230b1220 /><text x=50% y=50% fill=%23ffffff dominant-baseline=middle text-anchor=middle font-size=14>No imagen</text></svg>'" /></div>  
      <div class="meta">  
        <h3>${escapeHtml(title)}</h3>  
        <p>${escapeHtml((desc||'').slice(0,140))}</p>  
        <div class="sub">Juego: ${escapeHtml(game)} • ${escapeHtml(cat)} • Por: ${escapeHtml(createdByName)}</div>  
        <div class="sub" style="margin-top:6px;color:var(--muted)">ID: ${id} • ${h.timestamp ? new Date(h.timestamp).toLocaleString() : ''}</div>  
      </div>  
      <div class="controls-hack">  
        <button class="edit" data-id="${id}">Editar</button>  
        <button class="del" data-id="${id}">Eliminar</button>  
      </div>  
    `;  
    hacksList.appendChild(div);  
  });  

  hacksList.querySelectorAll('button.edit').forEach(b=>{  
    b.onclick = () => startEditHack(b.dataset.id);  
  });  
  hacksList.querySelectorAll('button.del').forEach(b=>{  
    b.onclick = async () => {  
      const id = b.dataset.id;  
      const h = allHacks[id];  
      const userEmail = auth.currentUser?.email || '';  
      const username = currentUserProfile?.username || '';  
      if (!(h.createdBy === userEmail || h.createdByUsername === username)){  
        return showToast("No puedes eliminar hacks de otros usuarios");  
      }  
      if (!confirm('¿Eliminar este hack? Esto no se puede deshacer')) return;  
      try {  
        showOverlay(true);  
        await remove(ref(db, 'hacks/' + id));  
        showToast('Hack eliminado');  
      } catch(e){  
        console.error(e);  
        showToast('Error al eliminar');  
      } finally {  
        showOverlay(false);  
      }  
    };  
  });  
}  

function startEditHack(id){  
  const h = allHacks[id];  
  if (!h) return showToast('Hack no encontrado');  
  const userEmail = auth.currentUser?.email || '';  
  const username = currentUserProfile?.username || '';  
  if (!(h.createdBy === userEmail || h.createdByUsername === username)){  
    return showToast("No puedes editar hacks de otros usuarios");  
  }  
  editingId = id;  
  document.getElementById('formTitle').textContent = 'Editar hack — ' + id;  
  titleIn.value = h.title || '';  
  gameIn.value = h.game || '';  
  categoryIn.value = h.category || '';  
  descriptionIn.value = h.description || '';  
  imageURLIn.value = h.imageURL || '';  
  previewThumb.src = h.imageURL || '';  
  pvImg.src = h.imageURL || '';  
  downloadURLIn.value = h.downloadURL || '';  
  ownerVideoURLIn.value = h.ownerVideoURL || '';  
  rightsIn.value = h.rights || '';  
  createdByIn.value = h.createdByUsername || h.createdBy || '';  
  saveHackBtn.textContent = 'Guardar cambios';  
  updatePreview();  
  window.scrollTo({ top: 0, behavior: 'smooth' });  
}  

// (el resto de tu JS queda igual, con saveHackBtn, métricas, etc.)

</script>  
</body>  
</html>
