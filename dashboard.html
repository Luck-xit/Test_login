<!doctype html>
<html lang="es">  
<head>  
<meta charset="utf-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1" />  
<title>Dashboard - Hacks Gratis</title>  
<link rel="icon" href="data:;base64,iVBORw0KGgo=">  
<style>  
  :root{  
    --bg:#0f1724;  
    --card:#0b1220;  
    --accent:#2575fc;  
    --muted:#9aa6bf;  
    --glass: rgba(255,255,255,0.04);  
    --success:#1abc9c;  
  }  
  *{box-sizing:border-box}  
  body{  
    margin:0;  
    font-family:Inter,system-ui,Arial,sans-serif;  
    background: linear-gradient(180deg,#071228 0%, #0b1830 100%);  
    color:#e6eef6;  
    min-height:100vh;  
  }  header{
display:flex;
gap:16px;
align-items:center;
justify-content:space-between;
padding:18px 20px;
border-bottom:1px solid rgba(255,255,255,0.03);
background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
}
.brand{display:flex;gap:12px;align-items:center}
.logo{
width:44px;height:44px;border-radius:8px;
background:linear-gradient(135deg,var(--accent),#6a11cb);
display:flex;align-items:center;justify-content:center;font-weight:700;
box-shadow:0 6px 18px rgba(37,117,252,0.15);
}
.brand h1{font-size:18px;margin:0}

.controls {
display:flex;
align-items:center;
gap:14px;
}
.search {
padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);
background:var(--glass); color:var(--muted); min-width:220px;
}
.stats {
display:flex;
gap:8px;
}
.stat {
background:rgba(255,255,255,0.02);
padding:6px 10px;border-radius:10px;font-size:13px;color:var(--muted)
}

/* üîπ Bot√≥n de 3 punticos */
.menu-toggle {
background:transparent;
border:0;
color:white;
font-size:22px;
cursor:pointer;
padding:4px 8px;
border-radius:8px;
}

/* üîπ Men√∫ flotante */
.dropdown-menu {
position:absolute;
top:60px;
right:20px;
background:var(--card);
border:1px solid rgba(255,255,255,0.08);
border-radius:12px;
box-shadow:0 6px 18px rgba(0,0,0,0.4);
display:none;
flex-direction:column;
min-width:220px;
z-index:100;
padding:10px;
}
.dropdown-menu.show{display:flex}

.dropdown-menu div{
padding:8px 10px;
font-size:14px;
color:var(--muted);
border-radius:8px;
display:flex;
justify-content:space-between;
align-items:center;
}
.dropdown-menu div:hover{
background:rgba(255,255,255,0.05);
color:white;
}
.dropdown-menu button{
margin-top:6px;
border:0;
padding:8px 12px;
border-radius:8px;
cursor:pointer;
font-weight:600;
}
.btn-admin{background:var(--accent);color:white;width:100%}
.btn-logout{background:#e74c3c;color:white;width:100%}
.btn-delete{background:#c0392b;color:white;width:100%;margin-top:6px}

/* small modal simple */
.modal-backdrop{
position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:200;
}
.modal{
background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:90%;
box-shadow:0 6px 24px rgba(0,0,0,0.6);color:#e6eef6;
}
.modal h3{margin:0 0 8px}
.modal p{margin:0 0 12px;color:var(--muted)}
.modal .row{display:flex;gap:8px}
.modal input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}

.main-loading{display:none;padding:10px 12px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted);font-size:13px;margin-left:8px}

main{padding:20px;max-width:1200px;margin:18px auto}
.top-row{display:flex;justify-content:space-between;gap:20px;align-items:center;flex-wrap:wrap;margin-bottom:18px}
.cards{display:flex;gap:12px;flex-wrap:wrap}
.card {
background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
border-radius:12px;padding:12px;min-width:220px;flex:1 1 200px;box-shadow:0 6px 18px rgba(0,0,0,0.4);
}
.section-title{margin:18px 0 8px;color:var(--muted);font-weight:600}

.game {
margin:20px 0;
border-radius:12px;
padding:10px;
background: rgba(255,255,255,0.02);
}
.game h2{margin:0 0 16px;font-size:18px}

.mods{
display:grid;
grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
gap:16px;
}

/* üîπ Dise√±o de cada mod en formato "box/tarjeta" */
.mod {
display:flex;
flex-direction:column;
background:var(--card);
border-radius:12px;
box-shadow:0 4px 12px rgba(0,0,0,0.3);
overflow:hidden;
transition:transform 0.2s ease;
}
.mod:hover{transform:translateY(-4px)}

.mod .thumb{
width:100%;
height:160px;
background:#071427;
overflow:hidden;
display:flex;
align-items:center;
justify-content:center;
}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}

.meta{
flex:1;
padding:12px;
display:flex;
flex-direction:column;
gap:6px;
}
.meta h3{margin:0;font-size:16px}
.meta p{margin:0;font-size:13px;color:var(--muted)}
.meta .tags{font-size:12px;color:var(--muted)}
.rights{font-size:11px;color:var(--muted)}

.actionsCol{
display:flex;
gap:8px;
padding:10px;
border-top:1px solid rgba(255,255,255,0.06);
justify-content:space-between;
}
.actionsCol a{
display:inline-block;
padding:8px 10px;
border-radius:8px;
text-decoration:none;
font-weight:600;
font-size:13px;
text-align:center;
flex:1;
}
.download{background:var(--success);color:#04211a}
.video{background:#fff;color:#000}

footer{padding:20px;text-align:center;color:var(--muted);font-size:13px}

@media (max-width:720px){
.mods{grid-template-columns:1fr}
}
</style>

</head>  
<body>  
  <header>  
    <div class="brand">  
      <div class="logo">LM</div>  
      <div>  
        <h1>Luck modz ‚Äî Hacks Gratis</h1>  
        <div style="font-size:12px;color:var(--muted)">Panel p√∫blico para usuarios autenticados</div>  
      </div>  
    </div>  <div class="controls">  
  <input id="searchInput" class="search" placeholder="Buscar por nombre del juego..." />  
  <div class="stats">  
    <div class="stat" id="totalHacks">Hacks: 0</div>  
    <div class="stat" id="totalUsers">Usuarios: ‚Äî</div>  
  </div>  

  <!-- Bot√≥n de men√∫ de 3 puntos -->  
  <button class="menu-toggle" id="menuToggle">‚ãÆ</button>  

  <!-- Men√∫ desplegable -->  
  <div class="dropdown-menu" id="dropdownMenu">  
    <div id="userEmail">cargando...</div>  
    <button class="btn-admin" id="openAdmin" style="display:none;">Abrir admin</button>  
    <button class="btn-delete" id="deleteAccountBtn">Eliminar cuenta</button>
    <button class="btn-logout" id="logoutBtn">Cerrar sesi√≥n</button>  
  </div>  
</div>

  </header>    <main>  
    <div class="top-row">  
      <div>  
        <div class="section-title">Categor√≠as</div>  
        <div class="cards" id="categoryCards"></div>  
      </div>  
    </div>  <div id="resultsContainer"></div>

  </main>    <footer>¬© Luck modz ‚Äî 2024 - 2025</footer>

  <!-- Simple modal for messages / password input -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Confirmaci√≥n</h3>
      <p id="modalDesc">...</p>
      <div id="modalContent" class="row">
        <!-- content injected dynamically -->
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="modalCancel" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Cancelar</button>
        <button id="modalOk" style="padding:8px 12px;border-radius:8px;background:var(--accent);border:0;color:#fff">Aceptar</button>
      </div>
    </div>
  </div>

  <script type="module">  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";  
  import { 
    getAuth, onAuthStateChanged, signOut, deleteUser, EmailAuthProvider, reauthenticateWithCredential 
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";  
  import { getDatabase, ref, onValue, get, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";  
  
  const firebaseConfig = {  
    apiKey: "AIzaSyD9_Wps61TDrx6PVfKgzvgoQLGlIRrzSaA",  
    authDomain: "weblogin-bbd5f.firebaseapp.com",  
    databaseURL: "https://weblogin-bbd5f-default-rtdb.firebaseio.com",  
    projectId: "weblogin-bbd5f",  
    storageBucket: "weblogin-bbd5f.firebasestorage.app",  
    messagingSenderId: "446557224878",  
    appId: "1:446557224878:web:0c626cf886d4ae9ad9523f",  
    measurementId: "G-33G9QVHQGQ"  
  };  
  
  const app = initializeApp(firebaseConfig);  
  const auth = getAuth(app);  
  const db = getDatabase(app);  
  
  const searchInput = document.getElementById('searchInput');  
  const resultsContainer = document.getElementById('resultsContainer');  
  const categoryCards = document.getElementById('categoryCards');  
  const totalHacksEl = document.getElementById('totalHacks');  
  const totalUsersEl = document.getElementById('totalUsers');  
  const userEmailEl = document.getElementById('userEmail');  
  const logoutBtn = document.getElementById('logoutBtn');  
  const openAdminBtn = document.getElementById('openAdmin');  
  const menuToggle = document.getElementById('menuToggle');  
  const dropdownMenu = document.getElementById('dropdownMenu');  
  const deleteAccountBtn = document.getElementById('deleteAccountBtn');

  // modal elements
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const modalContent = document.getElementById('modalContent');
  const modalCancel = document.getElementById('modalCancel');
  const modalOk = document.getElementById('modalOk');

  let allHacks = {};  
  let allUsersCount = null;  
  let currentUser = null;

  function showModal({ title='Confirmaci√≥n', desc='', placeholder='', okText='Aceptar', showInput=true }) {
    modalTitle.textContent = title;
    modalDesc.textContent = desc;
    modalContent.innerHTML = '';
    if (showInput) {
      const input = document.createElement('input');
      input.type = 'password';
      input.placeholder = placeholder || 'Contrase√±a';
      input.id = 'modalPasswordInput';
      modalContent.appendChild(input);
      setTimeout(()=> input.focus(),50);
    }
    modalOk.textContent = okText;
    modalBackdrop.style.display = 'flex';
  }
  function hideModal(){ modalBackdrop.style.display = 'none'; modalContent.innerHTML = ''; }

  modalCancel.addEventListener('click', ()=> hideModal());
  modalBackdrop.addEventListener('click', (e)=> { if (e.target === modalBackdrop) hideModal(); });

  menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));  
  document.addEventListener('click', (e)=>{  
    if (!dropdownMenu.contains(e.target) && e.target !== menuToggle){  
      dropdownMenu.classList.remove('show');  
    }  
  });  

  onAuthStateChanged(auth, async (user) => {  
    if (!user) {  
      window.location.href = 'index.html';  
      return;  
    }  
    currentUser = user;
    userEmailEl.textContent = user.email || 'usuario';  
    try {  
      const usersSnap = await get(ref(db, 'users'));  
      allUsersCount = usersSnap.exists() ? Object.keys(usersSnap.val()).length : 0;  
      totalUsersEl.textContent = `Usuarios: ${allUsersCount}`;  
    } catch (e) {  
      totalUsersEl.textContent = `Usuarios: ‚Äî`;  
    }  
  
    try {  
      const userSnap = await get(ref(db, 'users/' + user.uid));  
      if (userSnap.exists() && userSnap.val().authorized) {  
        openAdminBtn.style.display = "block";  
      } else {  
        openAdminBtn.style.display = "none";  
      }  
    } catch (e) {  
      console.error("Error leyendo autorizaci√≥n:", e);  
      openAdminBtn.style.display = "none";  
    }  
  });  
  
  const hacksRef = ref(db, 'hacks');  
  onValue(hacksRef, (snapshot) => {  
    const val = snapshot.val() || {};  
    allHacks = val;  
    renderOverviewAndResults();  
  });  
  
  function groupByGame(hacksObj) {  
    const map = {};  
    Object.entries(hacksObj).forEach(([id, hack]) => {  
      const game = (hack.game || 'Sin juego').trim();  
      if (!map[game]) map[game] = [];  
      map[game].push({ id, ...hack });  
    });  
    for (const g in map) {  
      map[g].sort((a,b) => (b.timestamp||0) - (a.timestamp||0));  
    }  
    return map;  
  }  
  
  function renderOverviewAndResults(filterText = '') {  
    const filter = (filterText||'').trim().toLowerCase();  
    const hacksFiltered = {};  
    Object.entries(allHacks).forEach(([id, hack])=>{  
      if (!filter || (hack.game && hack.game.toLowerCase().includes(filter))) {  
        hacksFiltered[id] = hack;  
      }  
    });  
  
    const total = Object.keys(allHacks).length;  
    totalHacksEl.textContent = `Hacks: ${total}`;  
  
    const catCounts = {};  
    Object.values(allHacks).forEach(h=>{  
      const c = (h.category || 'Sin categor√≠a').trim();  
      catCounts[c] = (catCounts[c]||0) + 1;  
    });  
    renderCategoryCards(catCounts);  
  
    const grouped = groupByGame(hacksFiltered);  
    renderGroupedResults(grouped);  
  }  
  
  function renderCategoryCards(catCounts) {  
    categoryCards.innerHTML = '';  
    if (!catCounts || Object.keys(catCounts).length===0) {  
      categoryCards.innerHTML = `<div class="card">Sin categor√≠as</div>`;  
      return;  
    }  
    Object.entries(catCounts).forEach(([cat, count])=>{  
      const el = document.createElement('div');  
      el.className = 'card';  
      el.innerHTML = `<div style="font-weight:700">${cat}</div><div style="color:var(--muted);margin-top:6px">${count} hacks</div>`;  
      categoryCards.appendChild(el);  
    });  
  }  
  
  function renderGroupedResults(grouped) {  
    resultsContainer.innerHTML = '';  
    const games = Object.keys(grouped).sort((a,b)=>a.localeCompare(b));  
    if (games.length===0) {  
      resultsContainer.innerHTML = `<div style="padding:24px;background:rgba(255,255,255,0.02);border-radius:10px;text-align:center;color:var(--muted)">No se encontraron hacks para la b√∫squeda.</div>`;  
      return;  
    }  
  
    games.forEach(game=>{  
      const mods = grouped[game];  
      const gameEl = document.createElement('section');  
      gameEl.className = 'game';  
      gameEl.innerHTML = `<h2>${escapeHtml(game)} ‚Äî <small style="color:var(--muted);font-weight:600">${mods.length} mods</small></h2>`;  
      const modsContainer = document.createElement('div');  
      modsContainer.className = 'mods';  
  
      mods.forEach(mod=>{  
        const row = document.createElement('div');  
        row.className = 'mod';  
        row.innerHTML = `  
          <div class="thumb">  
            <img loading="lazy" src="${escapeAttr(mod.imageURL || '')}" alt="${escapeAttr(mod.title||'imagen')}"  
            onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'120\\'><rect width=\\'100%\\' height=\\'100%\\' fill=\\'%230b1220\\' /><text x=\\'50%\\' y=\\'50%\\' fill=\\'%23ffffff\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-size=\\'14\\'>No imagen</text></svg>'">  
          </div>  
          <div class="meta">  
            <h3>${escapeHtml(mod.title || 'Sin t√≠tulo')}</h3>  
            <p>${escapeHtml(mod.description ? String(mod.description).slice(0,180) : '')}</p>  
            <div class="tags">Categor√≠a: ${escapeHtml(mod.category || 'Sin categor√≠a')} ‚Ä¢ Publicado por: ${escapeHtml(mod.createdByUsername || 'An√≥nimo')}</div>  
            <div class="rights">Derechos: ${escapeHtml(mod.rights || 'No especificado')}</div>  
          </div>  
          <div class="actionsCol">  
            <a class="download" href="${escapeAttr(mod.downloadURL||'#')}" target="_blank" rel="noopener">Descargar</a>  
            ${mod.ownerVideoURL ? `<a class="video" href="${escapeAttr(mod.ownerVideoURL)}" target="_blank" rel="noopener">Ver video</a>` : ''}  
          </div>  
        `;  
        modsContainer.appendChild(row);  
      });  
  
      gameEl.appendChild(modsContainer);  
      resultsContainer.appendChild(gameEl);  
    });  
  }  
  
  function escapeHtml(s){  
    if (!s) return '';  
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');  
  }  
  function escapeAttr(s){  
    if (!s) return '';  
    return String(s).replaceAll('"','%22').replaceAll("'",'%27');  
  }  
  
  openAdminBtn.addEventListener('click', ()=> window.location.href = 'admin.html');  
  logoutBtn.addEventListener('click', async ()=>{  
    try {  
      await signOut(auth);  
      window.location.href = 'index.html';  
    } catch(e){  
      console.error(e);  
      alert('Error al cerrar sesi√≥n');  
    }  
  });  

  // ---------------------------
  // Eliminar cuenta: l√≥gica
  // ---------------------------
  deleteAccountBtn.addEventListener('click', async ()=> {
    if (!currentUser) {
      alert('No hay usuario autenticado.');
      return;
    }

    // Confirmaci√≥n inicial
    const ok = confirm('¬øEst√°s seguro que quieres eliminar tu cuenta? Esta acci√≥n es irreversible.');
    if (!ok) return;

    // Mostrar modal pidiendo contrase√±a
    showModal({
      title: 'Eliminar cuenta',
      desc: 'Para eliminar tu cuenta escribe tu contrase√±a para confirmar (solo funciona para usuarios con email/contrase√±a).',
      placeholder: 'Ingresa tu contrase√±a',
      okText: 'Eliminar',
      showInput: true
    });

    modalOk.onclick = async () => {
      const pwdInput = document.getElementById('modalPasswordInput');
      const password = pwdInput ? pwdInput.value : '';
      if (!password) {
        alert('Ingresa la contrase√±a para confirmar.');
        return;
      }

      modalOk.disabled = true;
      modalOk.textContent = 'Eliminando...';

      try {
        // Solo se puede reautenticar con credenciales Email/Password
        if (!currentUser.email) {
          throw new Error('Este usuario no tiene email asociado; no es posible reautenticar con contrase√±a.');
        }

        const credential = EmailAuthProvider.credential(currentUser.email, password);
        await reauthenticateWithCredential(currentUser, credential);

        // 1) Borrar datos del usuario en /users/{uid}
        try {
          await remove(ref(db, 'users/' + currentUser.uid));
        } catch(e) {
          console.warn('Error borrando nodo users:', e);
        }

        // 2) Borrar hacks/entradas donde el usuario sea el owner (revisa distintos campos)
        try {
          const hacksSnap = await get(ref(db, 'hacks'));
          if (hacksSnap.exists()) {
            const hacksObj = hacksSnap.val();
            const deletions = [];
            Object.entries(hacksObj).forEach(([hackId, hack]) => {
              // revisa varios campos que podr√≠an referenciar al usuario
              const ownerFields = [
                hack.createdByUid,
                hack.ownerUid,
                hack.ownerId,
                hack.createdById,
                hack.userId,
                hack.owner,
                hack.createdBy
              ];
              // si alguno coincide con el uid o con el email, lo borramos
              const matchesUid = ownerFields.some(f => f && String(f) === String(currentUser.uid));
              const matchesEmail = ownerFields.some(f => f && String(f) === String(currentUser.email));
              if (matchesUid || matchesEmail) {
                deletions.push(remove(ref(db, 'hacks/' + hackId)));
              }
            });
            if (deletions.length) await Promise.allSettled(deletions);
          }
        } catch(e) {
          console.warn('Error revisando/borrando hacks:', e);
        }

        // 3) Borrar otros nodos relacionados (opcional: ejemplo 'profiles' u otros)
        try {
          await remove(ref(db, 'profiles/' + currentUser.uid));
        } catch(e) {
          // ignorar si no existe
        }

        // 4) Finalmente borrar la cuenta de Auth
        try {
          await deleteUser(currentUser);
        } catch(e) {
          // si falla por token expirado o similar, informar
          console.error('Error borrando cuenta Auth:', e);
          throw e;
        }

        hideModal();
        alert('Tu cuenta y datos asociados fueron eliminados. Ser√°s redirigido.');
        // Aun si deleteUser sucedi√≥, intentar cerrar sesi√≥n y redirigir.
        try { await signOut(auth); } catch(_) {}
        window.location.href = 'index.html';
      } catch (err) {
        console.error('Error durante eliminaci√≥n:', err);
        // Mensajes claros seg√∫n tipo de error
        let msg = 'Ocurri√≥ un error al intentar eliminar la cuenta.';
        if (err && err.code) {
          if (err.code === 'auth/wrong-password') msg = 'Contrase√±a incorrecta.';
          else if (err.code === 'auth/requires-recent-login') msg = 'Necesitas iniciar sesi√≥n recientemente. Por favor vuelve a iniciar sesi√≥n e int√©ntalo de nuevo.';
          else if (err.code === 'auth/user-not-found') msg = 'Usuario no encontrado.';
          else if (err.code === 'auth/invalid-credential') msg = 'Credencial inv√°lida.';
        } else if (typeof err === 'string') {
          msg = err;
        } else if (err && err.message) {
          msg = err.message;
        }
        alert(msg);
      } finally {
        modalOk.disabled = false;
        modalOk.textContent = 'Eliminar';
      }
    };
  });

  // init render
  renderOverviewAndResults();

  // simple search binding
  searchInput.addEventListener('input', (e)=> renderOverviewAndResults(e.target.value));

</script>  
</body>  
</html>
